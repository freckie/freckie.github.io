---
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import { SITE_TITLE } from '../../consts';
---

<!doctype html>
<html lang="ko">
  <head>
    <BaseHead title={`PDF Merger | ${SITE_TITLE}`} description="여러 PDF 파일 병합" />
    <script is:inline src="/wasm/wasm_exec.js"></script>
    <style is:global>
      main {
        width: 720px;
        max-width: calc(100% - 2em);
        margin: auto;
        padding: 2em 1em;
      }
      .page-header {
        text-align: center;
        margin-bottom: 2em;
      }
      .page-title {
        font-size: 2em;
        font-weight: 600;
        margin: 0 0 0.5em 0;
        color: rgb(var(--black));
      }
      .page-description {
        color: rgb(var(--gray));
        font-size: 1rem;
        margin: 0;
      }
      .tool-container {
        background: white;
        border-radius: 12px;
        padding: 2em;
        box-shadow: 0 2px 8px rgba(var(--gray), 10%);
        border: 1px solid rgb(var(--gray-light));
      }
      .upload-area {
        border: 2px dashed rgb(var(--gray-light));
        border-radius: 8px;
        padding: 3em 2em;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 1.5em;
      }
      .upload-area:hover {
        border-color: var(--accent);
        background: rgba(var(--accent-rgb), 0.05);
      }
      .upload-area.has-files {
        border-style: solid;
        border-color: var(--accent);
      }
      .upload-area.disabled {
        opacity: 0.5;
        pointer-events: none;
      }
      .upload-area iconify-icon {
        font-size: 3rem;
        color: rgb(var(--gray));
        margin-bottom: 0.5em;
      }
      .upload-text {
        color: rgb(var(--gray));
        margin: 0;
      }
      .upload-hint {
        font-size: 0.875rem;
        color: rgb(var(--gray-light));
        margin-top: 0.5em;
      }
      .file-input {
        display: none;
      }
      .pdf-list {
        display: none;
        flex-direction: column;
        gap: 0.5em;
        margin-bottom: 1.5em;
        max-height: 400px;
        overflow-y: auto;
      }
      .pdf-list.visible {
        display: flex;
      }
      .pdf-item {
        display: flex;
        align-items: center;
        gap: 0.75em;
        padding: 0.75em 1em;
        background: rgba(var(--gray-light), 0.2);
        border-radius: 8px;
        cursor: grab;
        transition: all 0.2s;
      }
      .pdf-item:active {
        cursor: grabbing;
      }
      .pdf-item.dragging {
        opacity: 0.5;
        background: rgba(var(--accent-rgb), 0.1);
      }
      .pdf-item.drag-over {
        border: 2px dashed var(--accent);
        background: rgba(var(--accent-rgb), 0.05);
      }
      .order-number {
        width: 28px;
        height: 28px;
        background: var(--accent);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        font-weight: 600;
        flex-shrink: 0;
      }
      .drag-handle {
        color: rgb(var(--gray));
        font-size: 1.25rem;
        cursor: grab;
      }
      .pdf-icon {
        color: #e74c3c;
        font-size: 1.5rem;
        flex-shrink: 0;
      }
      .pdf-details {
        flex: 1;
        min-width: 0;
      }
      .pdf-name {
        font-size: 0.875rem;
        font-weight: 500;
        color: rgb(var(--black));
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .pdf-size {
        font-size: 0.75rem;
        color: rgb(var(--gray));
      }
      .remove-btn {
        background: none;
        border: none;
        color: rgb(var(--gray));
        cursor: pointer;
        font-size: 1.25rem;
        padding: 0.25em;
        transition: color 0.2s;
        flex-shrink: 0;
      }
      .remove-btn:hover {
        color: #e74c3c;
      }
      .file-count {
        text-align: center;
        font-size: 0.875rem;
        color: rgb(var(--gray));
        margin-bottom: 1em;
      }
      .file-count .limit-warning {
        color: #e74c3c;
      }
      .options-section {
        display: none;
        flex-direction: column;
        gap: 1em;
        margin-bottom: 1.5em;
        padding: 1em;
        background: rgba(var(--gray-light), 0.2);
        border-radius: 8px;
      }
      .options-section.visible {
        display: flex;
      }
      .option-row {
        display: flex;
        align-items: center;
        gap: 1em;
      }
      .option-label {
        font-size: 0.875rem;
        color: rgb(var(--gray-dark));
        min-width: 100px;
      }
      .option-input {
        flex: 1;
        padding: 0.5em 0.75em;
        border: 1px solid rgb(var(--gray-light));
        border-radius: 6px;
        font-size: 0.875rem;
      }
      .option-input:focus {
        outline: none;
        border-color: var(--accent);
      }
      .drag-hint {
        text-align: center;
        font-size: 0.75rem;
        color: rgb(var(--gray));
        margin-bottom: 1em;
      }
      .action-buttons {
        display: flex;
        gap: 1em;
      }
      .btn {
        flex: 1;
        padding: 1em 1.5em;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5em;
      }
      .btn-primary {
        background: var(--accent);
        color: white;
      }
      .btn-primary:hover {
        opacity: 0.9;
      }
      .btn-primary:disabled {
        background: rgb(var(--gray-light));
        cursor: not-allowed;
      }
      .btn-secondary {
        background: white;
        color: rgb(var(--gray-dark));
        border: 1px solid rgb(var(--gray-light));
      }
      .btn-secondary:hover {
        border-color: var(--accent);
        color: var(--accent);
      }
    </style>
  </head>
  <body>
    <Header />
    <main>
      <section class="page-header">
        <h1 class="page-title">PDF Merger</h1>
        <p class="page-description">여러 PDF 파일을 하나로 병합합니다.</p>
      </section>

      <div class="tool-container">
        <div class="upload-area" id="uploadArea">
          <iconify-icon icon="mdi:file-document-plus"></iconify-icon>
          <p class="upload-text">클릭하거나 PDF 파일을 드래그하세요.</p>
          <p class="upload-hint">최대 20개 파일 선택 가능</p>
          <input type="file" class="file-input" id="fileInput" accept=".pdf" multiple />
        </div>

        <p class="file-count" id="fileCount" style="display: none;"></p>
        <p class="drag-hint" id="dragHint" style="display: none;">드래그하여 순서를 변경할 수 있습니다.</p>

        <div class="pdf-list" id="pdfList"></div>

        <div class="options-section" id="optionsSection">
          <div class="option-row">
            <span class="option-label">출력 파일명</span>
            <input type="text" class="option-input" id="outputFilename" placeholder="merged.pdf" />
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-secondary" id="resetBtn">
            <iconify-icon icon="mdi:refresh"></iconify-icon>
            초기화
          </button>
          <button class="btn btn-primary" id="mergeBtn" disabled>
            <iconify-icon icon="mdi:download"></iconify-icon>
            병합 & 다운로드
          </button>
        </div>
      </div>
    </main>
    <Footer />

    <script>
      interface PdfFile {
        id: string;
        file: File;
      }

      const MAX_FILES = 20;

      const uploadArea = document.getElementById('uploadArea') as HTMLDivElement;
      const fileInput = document.getElementById('fileInput') as HTMLInputElement;
      const pdfList = document.getElementById('pdfList') as HTMLDivElement;
      const fileCount = document.getElementById('fileCount') as HTMLParagraphElement;
      const dragHint = document.getElementById('dragHint') as HTMLParagraphElement;
      const optionsSection = document.getElementById('optionsSection') as HTMLDivElement;
      const outputFilename = document.getElementById('outputFilename') as HTMLInputElement;
      const mergeBtn = document.getElementById('mergeBtn') as HTMLButtonElement;
      const resetBtn = document.getElementById('resetBtn') as HTMLButtonElement;

      let pdfs: PdfFile[] = [];
      let draggedItem: HTMLElement | null = null;

      uploadArea.addEventListener('click', () => {
        if (pdfs.length < MAX_FILES) {
          fileInput.click();
        }
      });
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        if (pdfs.length < MAX_FILES) {
          uploadArea.style.borderColor = 'var(--accent)';
        }
      });
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.style.borderColor = '';
      });
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '';
        const files = e.dataTransfer?.files;
        if (files) {
          handleFiles(Array.from(files));
        }
      });

      fileInput.addEventListener('change', () => {
        if (fileInput.files) {
          handleFiles(Array.from(fileInput.files));
        }
      });

      function handleFiles(files: File[]) {
        const pdfFiles = files.filter(f => f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf'));
        if (pdfFiles.length === 0) {
          alert('PDF 파일만 지원합니다.');
          return;
        }

        const remaining = MAX_FILES - pdfs.length;
        const filesToAdd = pdfFiles.slice(0, remaining);

        if (pdfFiles.length > remaining) {
          alert(`최대 ${MAX_FILES}개 파일만 추가할 수 있습니다. ${filesToAdd.length}개만 추가됩니다.`);
        }

        filesToAdd.forEach(file => {
          const pdfFile: PdfFile = {
            id: Math.random().toString(36).substr(2, 9),
            file
          };
          pdfs.push(pdfFile);
        });

        updateUI();
      }

      function updateUI() {
        pdfList.innerHTML = '';
        pdfs.forEach((pdf, index) => {
          const item = document.createElement('div');
          item.className = 'pdf-item';
          item.draggable = true;
          item.dataset.id = pdf.id;
          item.innerHTML = `
            <iconify-icon icon="mdi:drag" class="drag-handle"></iconify-icon>
            <span class="order-number">${index + 1}</span>
            <div class="pdf-details">
              <div class="pdf-name">${pdf.file.name}</div>
              <div class="pdf-size">${formatFileSize(pdf.file.size)}</div>
            </div>
            <button class="remove-btn" data-id="${pdf.id}">
              <iconify-icon icon="mdi:close"></iconify-icon>
            </button>
          `;

          item.addEventListener('dragstart', handleDragStart);
          item.addEventListener('dragend', handleDragEnd);
          item.addEventListener('dragover', handleDragOver);
          item.addEventListener('dragleave', handleDragLeave);
          item.addEventListener('drop', handleDrop);

          pdfList.appendChild(item);
        });

        if (pdfs.length > 0) {
          pdfList.classList.add('visible');
          optionsSection.classList.add('visible');
          uploadArea.classList.add('has-files');
          fileCount.style.display = 'block';
          dragHint.style.display = pdfs.length > 1 ? 'block' : 'none';

          const countText = `${pdfs.length}개의 PDF 파일`;
          if (pdfs.length >= MAX_FILES) {
            fileCount.innerHTML = `${countText} <span class="limit-warning">(최대)</span>`;
            uploadArea.classList.add('disabled');
          } else {
            fileCount.textContent = countText;
            uploadArea.classList.remove('disabled');
          }

          mergeBtn.disabled = pdfs.length < 2;

          if (!outputFilename.value) {
            const now = new Date();
            outputFilename.value = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.pdf`;
          }
        } else {
          pdfList.classList.remove('visible');
          optionsSection.classList.remove('visible');
          uploadArea.classList.remove('has-files');
          uploadArea.classList.remove('disabled');
          fileCount.style.display = 'none';
          dragHint.style.display = 'none';
          mergeBtn.disabled = true;
        }

        document.querySelectorAll('.remove-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = (e.currentTarget as HTMLElement).dataset.id;
            pdfs = pdfs.filter(pdf => pdf.id !== id);
            updateUI();
          });
        });
      }

      function handleDragStart(e: DragEvent) {
        draggedItem = e.currentTarget as HTMLElement;
        draggedItem.classList.add('dragging');
        if (e.dataTransfer) {
          e.dataTransfer.effectAllowed = 'move';
        }
      }

      function handleDragEnd(e: DragEvent) {
        if (draggedItem) {
          draggedItem.classList.remove('dragging');
          draggedItem = null;
        }
        document.querySelectorAll('.pdf-item').forEach(item => {
          item.classList.remove('drag-over');
        });
      }

      function handleDragOver(e: DragEvent) {
        e.preventDefault();
        const target = e.currentTarget as HTMLElement;
        if (target !== draggedItem && draggedItem) {
          target.classList.add('drag-over');
        }
      }

      function handleDragLeave(e: DragEvent) {
        const target = e.currentTarget as HTMLElement;
        target.classList.remove('drag-over');
      }

      function handleDrop(e: DragEvent) {
        e.preventDefault();
        const target = e.currentTarget as HTMLElement;
        target.classList.remove('drag-over');

        if (draggedItem && target !== draggedItem) {
          const draggedId = draggedItem.dataset.id;
          const targetId = target.dataset.id;

          const draggedIndex = pdfs.findIndex(pdf => pdf.id === draggedId);
          const targetIndex = pdfs.findIndex(pdf => pdf.id === targetId);

          if (draggedIndex !== -1 && targetIndex !== -1) {
            const [removed] = pdfs.splice(draggedIndex, 1);
            pdfs.splice(targetIndex, 0, removed);
            updateUI();
          }
        }
      }

      function formatFileSize(bytes: number): string {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      }

      resetBtn.addEventListener('click', () => {
        pdfs = [];
        fileInput.value = '';
        outputFilename.value = '';
        updateUI();
      });

      // WASM 로딩
      let wasmReady = false;
      const go = new Go();

      async function loadWasm() {
        try {
          const result = await WebAssembly.instantiateStreaming(
            fetch('/wasm/pdf-merger.wasm'),
            go.importObject
          );
          go.run(result.instance);
          wasmReady = true;
        } catch (err) {
          console.error('WASM 로딩 실패:', err);
        }
      }

      loadWasm();

      mergeBtn.addEventListener('click', async () => {
        if (pdfs.length < 2) return;

        if (!wasmReady) {
          alert('WASM 모듈을 로딩 중입니다. 잠시 후 다시 시도해주세요.');
          return;
        }

        mergeBtn.disabled = true;
        mergeBtn.innerHTML = '<iconify-icon icon="mdi:loading" class="spin"></iconify-icon> 병합 중...';

        try {
          // PDF 파일들을 Uint8Array로 변환
          const pdfArrays = await Promise.all(
            pdfs.map(async (pdf) => {
              const arrayBuffer = await pdf.file.arrayBuffer();
              return new Uint8Array(arrayBuffer);
            })
          );

          // WASM 함수 호출
          const result = await (window as any).pdfMerger.merge(pdfArrays, {});

          // 결과 다운로드
          const blob = new Blob([result], { type: 'application/pdf' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = outputFilename.value || 'merged.pdf';
          a.click();
          URL.revokeObjectURL(url);
        } catch (err) {
          console.error('PDF 병합 실패:', err);
          alert('PDF 병합 중 오류가 발생했습니다: ' + (err as Error).message);
        } finally {
          mergeBtn.disabled = false;
          mergeBtn.innerHTML = '<iconify-icon icon="mdi:download"></iconify-icon> 병합 & 다운로드';
        }
      });
    </script>
    <style>
      .spin {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    </style>
  </body>
</html>
