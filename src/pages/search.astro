---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE } from '../consts';
import { getCollection } from 'astro:content';

const posts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const postsData = posts.map(post => ({
  id: post.id,
  title: post.data.title,
  category: post.data.category,
  date: post.data.date.toISOString().split('T')[0],
}));
---

<!doctype html>
<html lang="ko">
  <head>
    <BaseHead title={`Search - ${SITE_TITLE}`} description="Search posts" />
    <style>
      .search-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding-top: 15vh;
        background: rgba(0, 0, 0, 0.5);
        z-index: 100;
      }
      .search-modal {
        width: 600px;
        max-width: calc(100% - 2em);
        background: white;
        border-radius: 12px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        overflow: hidden;
      }
      .search-input-container {
        display: flex;
        align-items: center;
        padding: 1em;
        border-bottom: 1px solid rgb(var(--gray-light));
      }
      .search-icon {
        width: 24px;
        height: 24px;
        margin-right: 0.75em;
        color: rgb(var(--gray));
      }
      .search-input {
        flex: 1;
        border: none;
        outline: none;
        font-size: 1.25rem;
        background: transparent;
        color: rgb(var(--gray-dark));
      }
      .search-input::placeholder {
        color: rgb(var(--gray));
      }
      .search-results {
        max-height: 400px;
        overflow-y: auto;
      }
      .search-result-item {
        display: block;
        padding: 1em;
        border-bottom: 1px solid rgb(var(--gray-light));
        text-decoration: none;
        color: rgb(var(--gray-dark));
        transition: background-color 0.15s;
      }
      .search-result-item:hover {
        background-color: rgb(var(--gray-light));
      }
      .search-result-item:last-child {
        border-bottom: none;
      }
      .result-title {
        font-weight: 600;
        margin-bottom: 0.25em;
      }
      .result-meta {
        font-size: 0.875rem;
        color: rgb(var(--gray));
      }
      .result-category {
        background-color: var(--accent);
        color: white;
        padding: 0.1em 0.4em;
        border-radius: 4px;
        font-size: 0.75em;
        margin-right: 0.5em;
      }
      .no-results {
        padding: 2em;
        text-align: center;
        color: rgb(var(--gray));
      }
      .search-hint {
        padding: 0.75em 1em;
        font-size: 0.875rem;
        color: rgb(var(--gray));
        background: rgb(var(--gray-light));
        text-align: center;
      }
      .search-hint kbd {
        background: white;
        padding: 0.2em 0.5em;
        border-radius: 4px;
        font-family: inherit;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      }
    </style>
  </head>
  <body>
    <Header />
    <div class="search-container" id="search-container">
      <div class="search-modal">
        <div class="search-input-container">
          <svg class="search-icon" viewBox="0 0 24 24">
            <path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path>
          </svg>
          <input
            type="text"
            class="search-input"
            id="search-input"
            placeholder="Search posts..."
            autofocus
          />
        </div>
        <div class="search-results" id="search-results">
          <!-- Results will be populated by JavaScript -->
        </div>
        <div class="search-hint">
          <kbd>ESC</kbd> to close
        </div>
      </div>
    </div>
    <Footer />

    <script define:vars={{ postsData }}>
      const searchInput = document.getElementById('search-input');
      const searchResults = document.getElementById('search-results');
      const searchContainer = document.getElementById('search-container');

      function renderResults(posts) {
        if (posts.length === 0) {
          searchResults.innerHTML = '<div class="no-results">No posts found</div>';
          return;
        }

        searchResults.innerHTML = posts.map(post => `
          <a href="/${post.id}/" class="search-result-item">
            <div class="result-title">${post.title}</div>
            <div class="result-meta">
              <span class="result-category">${post.category}</span>
              ${post.date}
            </div>
          </a>
        `).join('');
      }

      function search(query) {
        if (!query.trim()) {
          searchResults.innerHTML = '';
          return;
        }

        const lowerQuery = query.toLowerCase();
        const filtered = postsData.filter(post =>
          post.title.toLowerCase().includes(lowerQuery) ||
          post.category.toLowerCase().includes(lowerQuery)
        );
        renderResults(filtered);
      }

      // Initial render - empty
      searchResults.innerHTML = '';

      // Search on input
      searchInput.addEventListener('input', (e) => {
        search(e.target.value);
      });

      // Close on ESC
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          window.location.href = '/';
        }
      });

      // Close on background click
      searchContainer.addEventListener('click', (e) => {
        if (e.target === searchContainer) {
          window.location.href = '/';
        }
      });
    </script>
  </body>
</html>
