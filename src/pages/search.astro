---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE } from '../consts';
import { getCollection } from 'astro:content';

const posts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const postsData = posts.map(post => ({
  id: post.id,
  title: post.data.title,
  category: post.data.category,
  date: post.data.date.toISOString().split('T')[0],
}));
---

<!doctype html>
<html lang="ko">
  <head>
    <BaseHead title={`Search - ${SITE_TITLE}`} description="Search posts" />
    <style>
      .search-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding-top: 12vh;
        background: rgba(15, 18, 25, 0.6);
        backdrop-filter: blur(4px);
        z-index: 100;
      }
      .search-modal {
        width: 560px;
        max-width: calc(100% - 2em);
        background: white;
        border-radius: 16px;
        box-shadow: 0 25px 60px -15px rgba(0, 0, 0, 0.35);
        overflow: hidden;
      }
      .search-input-container {
        display: flex;
        align-items: center;
        padding: 1.25em 1.5em;
        border-bottom: 1px solid rgba(var(--gray-light), 0.8);
      }
      .search-icon {
        width: 22px;
        height: 22px;
        margin-right: 1em;
        color: var(--accent);
        flex-shrink: 0;
      }
      .search-input {
        flex: 1;
        border: none;
        outline: none;
        font-size: 1.1rem;
        background: transparent;
        color: rgb(var(--gray-dark));
      }
      .search-input::placeholder {
        color: rgb(var(--gray));
      }
      .search-results {
        max-height: 420px;
        overflow-y: auto;
        padding: 0.5em 0;
      }
      .search-results::-webkit-scrollbar {
        width: 6px;
      }
      .search-results::-webkit-scrollbar-thumb {
        background: rgb(var(--gray-light));
        border-radius: 3px;
      }
      .search-result-item {
        display: block;
        padding: 1em 1.5em;
        margin: 0.25em 0.5em;
        border-radius: 10px;
        text-decoration: none;
        color: rgb(var(--gray-dark));
        transition: all 0.2s ease;
      }
      .search-result-item:hover {
        background: linear-gradient(135deg, rgba(17, 120, 147, 0.08), rgba(52, 85, 139, 0.08));
      }
      .result-title {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 0.5em;
        line-height: 1.4;
      }
      .search-result-item:hover .result-title {
        color: var(--accent);
      }
      .result-meta {
        display: flex;
        align-items: center;
        gap: 0.75em;
        font-size: 0.8rem;
        color: rgb(var(--gray));
      }
      .result-category {
        background: linear-gradient(135deg, var(--accent), var(--accent-dark));
        color: white;
        padding: 0.2em 0.6em;
        border-radius: 5px;
        font-size: 0.75rem;
        font-weight: 500;
      }
      .result-date {
        color: rgb(var(--gray));
      }
      .no-results {
        padding: 3em 2em;
        text-align: center;
        color: rgb(var(--gray));
      }
      .no-results-icon {
        font-size: 2.5em;
        margin-bottom: 0.5em;
        opacity: 0.5;
      }
      .search-hint {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5em;
        padding: 0.75em 1em;
        font-size: 0.8rem;
        color: rgb(var(--gray));
        background: rgba(var(--gray-light), 0.5);
        border-top: 1px solid rgba(var(--gray-light), 0.5);
      }
      .search-hint kbd {
        background: white;
        padding: 0.25em 0.6em;
        border-radius: 5px;
        font-family: inherit;
        font-weight: 500;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
    </style>
  </head>
  <body>
    <Header />
    <div class="search-container" id="search-container">
      <div class="search-modal">
        <div class="search-input-container">
          <svg class="search-icon" viewBox="0 0 24 24">
            <path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path>
          </svg>
          <input
            type="text"
            class="search-input"
            id="search-input"
            placeholder="Search posts..."
            autofocus
          />
        </div>
        <div class="search-results" id="search-results">
          <!-- Results will be populated by JavaScript -->
        </div>
        <div class="search-hint">
          <kbd>ESC</kbd> to close
        </div>
      </div>
    </div>
    <Footer />

    <script define:vars={{ postsData }}>
      const searchInput = document.getElementById('search-input');
      const searchResults = document.getElementById('search-results');
      const searchContainer = document.getElementById('search-container');

      function renderResults(posts) {
        if (posts.length === 0) {
          searchResults.innerHTML = `
            <div class="no-results">
              <div class="no-results-icon">üîç</div>
              <div>No posts found</div>
            </div>
          `;
          return;
        }

        searchResults.innerHTML = posts.map(post => `
          <a href="/${post.id}/" class="search-result-item">
            <div class="result-title">${post.title}</div>
            <div class="result-meta">
              <span class="result-category">${post.category}</span>
              <span class="result-date">${post.date}</span>
            </div>
          </a>
        `).join('');
      }

      function search(query) {
        if (!query.trim()) {
          searchResults.innerHTML = '';
          return;
        }

        const lowerQuery = query.toLowerCase();
        const filtered = postsData.filter(post =>
          post.title.toLowerCase().includes(lowerQuery) ||
          post.category.toLowerCase().includes(lowerQuery)
        );
        renderResults(filtered);
      }

      // Initial render - empty
      searchResults.innerHTML = '';

      // Search on input
      searchInput.addEventListener('input', (e) => {
        search(e.target.value);
      });

      // Close on ESC
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          window.location.href = '/';
        }
      });

      // Close on background click
      searchContainer.addEventListener('click', (e) => {
        if (e.target === searchContainer) {
          window.location.href = '/';
        }
      });
    </script>
  </body>
</html>
