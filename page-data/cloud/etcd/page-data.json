{"componentChunkName":"component---src-templates-blog-post-js","path":"/cloud/etcd/","result":{"data":{"site":{"siteMetadata":{"title":"Fr3ky's Lab.","author":"Freckie","siteUrl":"https://blog.frec.kr","comment":{"disqusShortName":"","utterances":"freckie/freckie.github.io"},"sponsor":{"buyMeACoffeeId":"freckie"}}},"markdownRemark":{"id":"335c49e4-4789-5bf5-8bf6-5c2217b32c5d","excerpt":"1. What is etcd? distributed reliable key-value store :   + istributed system (“엣-시디”로 읽음) 분산 시스템의 운영에 필요한 데이터를 관리하는 용도로 사용된다. 클러스터 구성을 위해 election, consensus(Raft) 등을 처리하고 관련 설정값을 관리한다. CNCF(Cloud Native Computing Foundation) Graduated 프로젝트. CNCF에서는 Coordination & Service…","html":"<h2 id=\"1-what-is-etcd\" style=\"position:relative;\"><a href=\"#1-what-is-etcd\" aria-label=\"1 what is etcd permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. What is etcd?</h2>\n<blockquote>\n<p>distributed reliable key-value store</p>\n</blockquote>\n<p>:  <code class=\"language-text\">/etc</code> + <code class=\"language-text\">d</code>istributed system (<em>“엣-시디”로 읽음</em>)</p>\n<ul>\n<li>분산 시스템의 운영에 필요한 데이터를 관리하는 용도로 사용된다.</li>\n<li>클러스터 구성을 위해 election, consensus(Raft) 등을 처리하고 관련 설정값을 관리한다.</li>\n<li>\n<p>CNCF(Cloud Native Computing Foundation) <em>Graduated</em> 프로젝트.</p>\n<ul>\n<li>CNCF에서는 Coordination &#x26; Service Discovery 역할을 하는 프로젝트라고 소개됨.</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"11-history\" style=\"position:relative;\"><a href=\"#11-history\" aria-label=\"11 history permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.1 History</h3>\n<p><strong>CoreOS Container Linux</strong>를 관리하기 위해 개발되었다.</p>\n<ul>\n<li>클라우드와 컨테이너에 최적화된 경량 리눅스 배포판 (약 100MB)</li>\n<li>보안을 위해 자동으로 OS를 업데이트한다.</li>\n<li>read-only 루트 파일 시스템을 2개 생성하여 업데이트 후 교체하는 방법으로 OS를 라이브 업데이트한다.</li>\n<li>그러나, RedHat에 인수된 후 2020.05 서비스 지원 종료되었다. (End of Service)</li>\n<li>후속 버전들 : <strong>*Fedora CoreOS</strong> / <strong>RHCOS*</strong>(RedHat CoreOS)</li>\n<li>RHCOS : OpenShift에 포함하기 위해 OCI를 지원하고 보안을 강화(SELinux 지원)</li>\n</ul>\n<h3 id=\"12-features\" style=\"position:relative;\"><a href=\"#12-features\" aria-label=\"12 features permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.2 Features</h3>\n<p><strong>Simple Interface</strong> : Read, Write는 JSON 포맷으로 HTTP를 통해 이루어졌다.</p>\n<p><strong>Key-value storage</strong> : 파일시스템처럼 계층화된 디렉토리에 데이터를 저장할 수 있다.</p>\n<p><strong>Watch for Changes</strong> : 특정 키나 디렉토리의 변경을 감시하다 변경에 react 할 수 있다.</p>\n<ul>\n<li>인스턴스 당 1초에 1000건의 write 성능</li>\n<li>SSL을 통한 인증 기능</li>\n<li>Fully Replicated</li>\n<li>key에 TTL (Time-to-live) 적용 가능</li>\n<li>Raft 알고리즘을 통해 분산됨</li>\n<li>Highly Available</li>\n</ul>\n<h3 id=\"13-used-by\" style=\"position:relative;\"><a href=\"#13-used-by\" aria-label=\"13 used by permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.3 Used by</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1071px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 10.666666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAjElEQVQI1x2MQQqCQAAA/f8/ekC36NQpKIgodFNJM0EWK1d3TSzbdjLnMnMaL5QDZd2hmxptDG1reNsvseqQSlPVDUqbyX+uaUl6llNba3HOcbtXqFpj2ifebNOxFQX+cU8gTkRhSD98WFweiFySZDlpXhAl2bhwLOc71qtgLEvfv6ahiBMOfkgUp/wAi1aUp/2CZz0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"20210630 1\"\n        title=\"20210630 1\"\n        src=\"/static/e550add1da9ab7c7936472e28ab2e464/705cc/20210630-1.png\"\n        srcset=\"/static/e550add1da9ab7c7936472e28ab2e464/5a46d/20210630-1.png 300w,\n/static/e550add1da9ab7c7936472e28ab2e464/0a47e/20210630-1.png 600w,\n/static/e550add1da9ab7c7936472e28ab2e464/705cc/20210630-1.png 1071w\"\n        sizes=\"(max-width: 1071px) 100vw, 1071px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><em>외 AWS, Google, IBM, Alibaba 등 회사들의 다수 상용 프로덕션들.</em></p>\n<p>(kubernetes, ROOK, CoreDNS는 CNCF 프로젝트이므로 M3만 간단히 소개함)</p>\n<p><strong>M3 (by Uber)</strong></p>\n<p>: a <em>Large-scale Time Series Metrics Platform for Prometheus</em></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 669px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACGUlEQVQoz5WS7UtTYRjGzz/Vt6i+RPQCMpCijL6k9IKRUoK9YLRIsCCTkAgxg+zFzCZJQ5QixXSzzS0aTbO0bZ41N910y+bZec7z65y9iKELug8X14H73Nf1PPd1lLsDCU62zlDbHqTm3nfanQk0A7RomJi9jvi1c6hNtSzbzyMWfmCVNAyklAUuQVgsUa4/j7Gjzseexk/suhRkvz1EaFmH+ALRmw0s3qgnYq8n0XwRoYY2BMuVEktp9LnSONwZ+ibSvHavsqZJEDnk/Aza9GdyXwMwF0SsZzcG19Q48Xde4iN+EqN+Ft96yMwuoJRz0sJzpE5V4KvcydTh3WRqDiG+BZHFfqR/xOw1MWhr4I3tAl7bFdROJ4q1C2FsgrULc8BIr7A00EPoRTfqy6esmO9GMpEXM4ROajZEbNDNz6FJ1GGTnROkp0PmCeXW01kmVq2b+JKOEEiH+b2pLyhfynZihiwsvcf3imO9Zzjae5pHnh6k10Wy/zFJRzfa2LCZrCikW2IzrH8KdnqfcbDzOAc6qmj72EX2YRtzZyuZrz1CprUJwxQwt2SyNSPzs2UEC1f2RwPcGX/A7Q/3mVR9pQ8Qeq78lWVReTtsMStC13Wy62YwawYrRSR/CbKaKP/bFAT+fvIJF30c40vsa3RRcfk9tquj7G0Yo2N4GcVy+x9omp7PeWhqlRMtfqpvuahuGaeq2cOT0RR/ADqzZ4AnEjPcAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"20210630 2\"\n        title=\"20210630 2\"\n        src=\"/static/df283bba7e5760e65b5b9792924c7e4e/99272/20210630-2.png\"\n        srcset=\"/static/df283bba7e5760e65b5b9792924c7e4e/5a46d/20210630-2.png 300w,\n/static/df283bba7e5760e65b5b9792924c7e4e/0a47e/20210630-2.png 600w,\n/static/df283bba7e5760e65b5b9792924c7e4e/99272/20210630-2.png 669w\"\n        sizes=\"(max-width: 669px) 100vw, 669px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 678px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 81.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC40lEQVQ4y42TjUtTYRTG99cVWRZhEFJRoRham2amtqUuFV2mppW2EpPC8CM/5zTNrIXW/ExLQ5QasabT2hzpyrnt3l/vvTc/KfDAuQ+Xe8/zPuec59WBxIM+L/G3XSRUuTh35zOJAk+WfaHupRclwpEokiTtK3UgU9LhJbbEw/GiGQ6Z3nLi5hwxxW4q7EsqYVSS2W/olEfHsA/TUw8FzxYwN2porPfQPe7fIpTl/aVOkvecLkV2v6rqtH9kWd6fQi20QikS2iLYGTvJ/qdOJVQWUtS6KOa4TEnnDyztCn7nVueiaN1Dy7vvStOi7ehW0V6luwjPVLqIr1wgrvgTR82jHDOPcDjnPcctHo5YfohZ+ncUsos0FA4JB4S3xyOLLZ+qcBFXJjZsmSc2/wOHzdOcKW/H8KSJi/XdFNh6GHI5mHCPEolq8536NkGFo5jSNwWUOgqoG7YSCAY0hX3vV2gY9NH8doVmZ4CmwTXKHVXk9iaRa7+IyZZCetsF8vuzWVnT1LZONpDRlYzRdhmT/TJZ3XoqBiysBP07l7Idj8eq0bcmcKUlBUNjEmktSSqh76dP/W6bbsXUl0bWMwPGzjQKXxvJsumpe2cVthG2WP0dwb8aFgrC+AIhPrrnccw7Gfk6zvTSJFMLE8wuzYjFaC13TbeRbddT+MrIjf4szL2ZqtJHw9XowhGJ3AYPKTXfSK11c6nmK1cfL5Ne56eyK7Dbk2LoSthn2jD2ppLZrFfbzh/I5potlUfO++hCG1HO3nMTW/yFg9cGOZA9yEHjEDFFn8Uhbn6tbyhUqm0kkdsKDeQ9zySn+4qKxq40ap1CYSQqccfuJa9pkcIWr/CeV8XcxkVqXiwTjUpbNtlU2DPbgaE5kYTy0yRbz5O32bLTurkUxZjidKXgL6rve67cJgbX13g4dJeM9mSu29MF4VV1ptahSnSay/99L/caWUNNZTAUpH6slluv8tUsfV3IwFwvfwDcylIEtKMyTQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"20210630 3\"\n        title=\"20210630 3\"\n        src=\"/static/c6c2b54854eb943ebeefa9a280ab3ef4/38cea/20210630-3.png\"\n        srcset=\"/static/c6c2b54854eb943ebeefa9a280ab3ef4/5a46d/20210630-3.png 300w,\n/static/c6c2b54854eb943ebeefa9a280ab3ef4/0a47e/20210630-3.png 600w,\n/static/c6c2b54854eb943ebeefa9a280ab3ef4/38cea/20210630-3.png 678w\"\n        sizes=\"(max-width: 678px) 100vw, 678px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><strong>Components</strong></p>\n<ul>\n<li><strong><em>M3DB</em></strong> : 분산 시계열 DB.</li>\n<li><strong><em>M3 Collector</em></strong> : 애플리케이션으로부터 메트릭을 수집한다.</li>\n<li><strong>M3 Aggregator</strong> : M3DB 노드에 메트릭을 저장하기 전에 stateful stream-based downsampling을 수행해 집계한다. 메트릭이 올바른 Aggregator 인스턴스로 라우팅되고, Aggregator 레플리카에 SPOF(Single Points of Failure)가 없도록 클러스터링과 레플리케이션을 지원한다.</li>\n<li><strong><em>M3 Coordinator</em></strong> : M3DB 위에서 query, storage interface를 제공하는 Prometheus sidecar. M3DB와 Prometheus 사이에 존재하는 브릿지 역할.</li>\n<li><strong><em>M3 Query</em></strong> : M3DB의 데이터를 쿼리하기 위한 분산 쿼리 엔진이다. 프로메테우스 호환 API를 제공하므로 Grafana와 같은 써드파티 솔루션도 사용 가능하다.</li>\n</ul>\n<p><strong>etcd의 사용</strong></p>\n<ul>\n<li>M3 Aggregator는 클러스터링과 레플리케이션을 지원하는데, etcd의 election과 window tracking을 활용해서 이러한 상태를 관리한다.</li>\n<li>또한, M3 Aggregator의 집계 기능은 etcd에 저장된 동적 규칙을 사용한다.</li>\n<li>M3 Coordinator에서도 etcd에 저장된 동적 규칙을 이용해 메트릭의 집계를 수행한다.</li>\n</ul>\n<p>다른 분산 시스템에서 시스템을 관리하는 용도로 주로 사용하는 듯.</p>\n<h2 id=\"2-architecture\" style=\"position:relative;\"><a href=\"#2-architecture\" aria-label=\"2 architecture permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Architecture</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAACDUlEQVQoz22S3U4TURSF58lMfAV9BW99AC/ESxGUNBASNQRjAleGYFRSCDcIIkpLi9Cm0MJQpu382vntz0zp9PPMEbxyJztr5px11t5ZeyuTyYQoivA8nyAIcV0Py7LRDRPbtkU6BGGIHwTybjgckr3JUNcNtOsmrZZGv99nPB6jcBtxHEvMDnu9HsNBHzfo3Z5PGKepvB+NEomBKOC5XS40nY5p4fue5CpZtUv1ilL5mGZTk4KiBX41u3w4aLJ9ohMNhOgklZ0flY6pnZ2TjG5koYb+m3CQyPsslDhOWHyzxGxugbfL72VnUZzyeDHPwyeveTC1QvmqKx9vbG0zMzfP9Ksc5/UGhmHQ1jRsy6LT6QjbPJTRaETpqMjPg32KxYLwzEJrGyznCyys7TG/tkupphJ4LpVKRfC+80NkJpaJNBoNVFWV2Gq1UIZJQu7jV56ubLH4aVcY38W0HB4t7XPv+Sb3p7f5VmlyMwhZ3yvzbHWLKcEt1xqyu/N6XYrVBWriX0kzD3WHalNHNRxhxV8vanZMvuqwU+/ezQ3b73Gqtql3HAbCqlhMOhtOKLYgw39TNgXxynLxhbm2H1G9NjG8SBptdn3O2o7g9OknN5LXdkNG45T/hZKtw9LOKbMbBdaLFxRUk5fiO7dZ4qTl8G63yovPh2wcqxxemsx8KTCXP0L3elIgTSdyL+/yD0unjKiFXGI/AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"20210630 4\"\n        title=\"20210630 4\"\n        src=\"/static/308eee5d40669087eff29e14325be80e/8c557/20210630-4.png\"\n        srcset=\"/static/308eee5d40669087eff29e14325be80e/5a46d/20210630-4.png 300w,\n/static/308eee5d40669087eff29e14325be80e/0a47e/20210630-4.png 600w,\n/static/308eee5d40669087eff29e14325be80e/8c557/20210630-4.png 700w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>(<a href=\"https://alibaba-cloud.medium.com/getting-started-with-kubernetes-etcd-a26cba0b4258\">https://alibaba-cloud.medium.com/getting-started-with-kubernetes-etcd-a26cba0b4258</a>)</p>\n<ul>\n<li>\n<p>etcd의 백엔드 DB는 BoltDB로 구성되어 있다. Go로 작성되었으며, 빠르고 가벼운 Key-Value Store이다.</p>\n<ul>\n<li>공식 깃허브 <a href=\"https://github.com/boltdb/bolt\">링크</a>로 들어가보니 리포지토리가 아카이브 되었고, 17년을 마지막으로 더 릴리즈가 올라오지 않고 있다.</li>\n</ul>\n</li>\n<li>\n<p>etcd는 주로 3개의 노드나 5개의 홀수 개 노드로 구성되며, 노드들은 <em>Raft</em> 합의 알고리즘을 이용해 협력한다.</p>\n<ul>\n<li>Quorum(정족수)은 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mfrac><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow><mn>2</mn></mfrac></mrow><annotation encoding=\"application/x-tex\">{n+1 \\over 2}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.190108em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.845108em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathdefault mtight\">n</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span>로 설정되어, 5노드 클러스터에서 2개 노드에서 fail이 발생해도 fault-tolerant하도록 구성되었다.</li>\n</ul>\n</li>\n<li>\n<p>클러스터에서 노드들은 <em>leader</em>와 <em>follower</em>로 구분되고, leader는 알고리즘에 따라 선출된다.</p>\n<ul>\n<li>leader는 follower들을 관리하고, 클라이언트에서 들어온 요청을 수락하고 follower에게 포워딩한다.</li>\n<li>만약 leader에서 fail이 발생한다면, 자동으로 다른 노드를 leader로 선출한다.</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"21-raft-consensus-algorithm\" style=\"position:relative;\"><a href=\"#21-raft-consensus-algorithm\" aria-label=\"21 raft consensus algorithm permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 Raft consensus algorithm</h3>\n<ul>\n<li>\n<p>복잡한 Lamport의 Paxos 알고리즘보다 더 이해하기 쉽게 설계된 consensus 알고리즘이다.</p>\n<ul>\n<li><strong>consensus</strong> : 분산 시스템에서 노드들이 fault-tolerant하게 합의를 이루는 과정.</li>\n</ul>\n</li>\n<li>Raft의 각 노드는 <em>Follower</em>, <em>Candidate</em>, <em>Leader</em>의 세 가지 state를 가지는 state machine이다.</li>\n</ul>\n<p><strong>Raft consensus 과정 간단히 알아보기</strong></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 417px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 94.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAAC00lEQVQ4y41UXU/TYBTurzMKYuJHvPI3CCLBGy+88EJv9G5CQNQIkwTDRVXAqIEoMUEgGwpssvGVwOjHuq7t1q0r2+M5b9vZASG8yUnP+/Wcnud9zpFwxmi1Wh3f9dw2lFJZ+M1ms2Pv5JDOAhJ+eNE0TSgzk1ifHIXlOKcCngSWzvor4ZP5NM8mh+D2d8O+142/8rsoWgdYHFRqT8ID0fy44aHk1pF+m0Cl/yqs+z1IT4/D9nzaa3QEjwNL7QVOkY38arUKTdNQLBaxs7ePleQIVqfeYP/gEEVdF3uu6yIkVRhzKwCjX22GVqvVoCoK9PCiYRjQ7QqKliMC8Jqm6VBVFW6t3r7XTrlQKMCpUrSNJWxNJJDNbMIolcTFCFSjy8LCNZ3X9CIM9Qjut/fIyJM4VIJ9aXntDwqLn9F6eBvV3stIDz+BUrYJQBGp87AsC7ZtC9+hl9YoA5X+2JXHUO+7AmfwOmZeDSGT3wlTPsjBfnAT5b4upMaeQ2VAusTp82CwSqUifMGvchQAziVRH7iGQl8P9lZ+BikzmczB3sIsVieGsb27K3gTHIXEM6ATapCBeU+j1PmBduQJbH79CK8ZSK0tGxaCRlEZLCBeOxdQcEmmmBZaMS23AX3Pgx4j/iKAQlq6Bj+mSykuyhK/Lh8mU8/lUAnOkHFpxkUuxUvHpcMqa4xTt2yYFIBfmGlgi3yVGoXQJvlR0AhDitcuLzkGAX5KYlmewhFpLdIfm0pS0s0y7N9L2BhPIJ/bOlWCHaXHgC15BF5/F7TBW0j9mEfJsgMaNFWAFdZ+ofHoDlzSX+bFY3gn+sD/btM8DpzZ16jcvQRl4AbWFhdglC3Bp0raM4iK1JwMpbdbAG6PPhXqiLpPu31FE5P+ZiO1inwygc0vH4S2+AWZJzbf9+E2fGTnppF++QzfF+ZR97xODuOTEpG8lcvjIoN7ZSabhROWZITxD01QkDJwQPxQAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"20210630 5\"\n        title=\"20210630 5\"\n        src=\"/static/b388d4253ceb5cb16497b8f6538cbcd3/f27fb/20210630-5.png\"\n        srcset=\"/static/b388d4253ceb5cb16497b8f6538cbcd3/5a46d/20210630-5.png 300w,\n/static/b388d4253ceb5cb16497b8f6538cbcd3/f27fb/20210630-5.png 417w\"\n        sizes=\"(max-width: 417px) 100vw, 417px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>그림 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>t</mi><mn>1</mn></msub></mrow><annotation encoding=\"application/x-tex\">t_1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 425px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 93.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAADHklEQVQ4y3VUW08TQRjdv0Z8MMaY+OIbDz7oA2pU0BgF4yUobwYDJt6IBE0kiiQqERMe0KgFRFGwWORSCrSlnb1vu73spXv8ZtqupdRNZzub+b4zZ853vpHQ6gkC+gViqmg6YhubYl6pVGrLAf73SHtxqoH8HdSSS4aGHxNj0DStutYA2gpYal7cE+g5wHAvnItHEBu8Dtv10Sp+D2DrxQAuMbGzaXi9x1E4exDbtzqwk2G11SAEbc4XgEKzii9CuU6WZUFmDIz0s+an4bwYwG50ARlFhaoocIqlmqYBfIrnOXVgKdSMB9DQdR2MwBRK5EM2LDDLhmIY9C0jKzPEklvI5/Oti1Isk06ei+LSDPTdFGRVgyLLkOuDwGWWhUnsLGJsqCqeLEcwtfoTiXgaE1MRMIrzCIMzlSJzXxG8GoR9/hBKQzerrCiAV9VxHBQKBZi6gVU1g8XsNgwCNnMmno+/RUfPMNrP3UPn5duYiXxBuVyG5HEJH3Qjf6oN3p0zULMZ2lGBYejiCC7tnDNMRFgC06k1WKqOcrGAoZGXaO96iI5ro+i62o+K7/JS1HzIduC+fgQj+g0yseHHNEgzAei60HQt1ChDa2mFYSsex92Bp+jpe4xf0VhYJKpy1ahayaWqGqF+jYC8UD6Po4SR37OYXFvErirjzco88qa2p4skYSF6WXRELn5dw2bA6vE9rO8mqTAaFrbXMb7yHRXHo33++VGqm5KLL+zCGWazIaBHIHVAzoKDKbzyZB8+5xs2dk8I6Pu+8BkjDRl5TyV72LYtTM7n3He5HBmeqsysPOlqhIVr7BipseUKjgt1dRn60pzwIxMeZEICPufV14nZzsdJLM3PifZs7udaL1eq3SKn4PadQPnSUeQ/v4Ns5kiCWtdwKYhVabQfzoXDiN84SezNfZeFVL+SxGd6A173MeROH0B58hmyZp70zFTZcabUKf79K7A62oCBTp5YzWtmWBc8mU7D/jQBfBhDpWjDoYIUCrbQskhFc3kTsCTwfgSp2WnBeB/DxqsnGo1CydnhJdvyMq/9/4lvIpFI7AP8CxpYkqz8O569AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"20210630 6\"\n        title=\"20210630 6\"\n        src=\"/static/16d02389f3250d277e3828778d780644/2fbbf/20210630-6.png\"\n        srcset=\"/static/16d02389f3250d277e3828778d780644/5a46d/20210630-6.png 300w,\n/static/16d02389f3250d277e3828778d780644/2fbbf/20210630-6.png 425w\"\n        sizes=\"(max-width: 425px) 100vw, 425px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>그림 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>t</mi><mn>2</mn></msub></mrow><annotation encoding=\"application/x-tex\">t_2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></p>\n<ul>\n<li>\n<p><strong>그림 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>t</mi><mn>1</mn></msub></mrow><annotation encoding=\"application/x-tex\">t_1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></strong>은 클러스터의 초기 상태를 나타냄. 모든 노드는 Follower이고, 타이머를 가지고 있다.</p>\n<ul>\n<li>타이머는 Leader의 응답을 받지 못한 시간만큼 흘러가게 된다.</li>\n</ul>\n</li>\n<li>\n<p>현재 Leader 노드가 없으므로, 먼저 timeout이 발생한 S2 노드가 Candidate로 전환되고 투표를 시작한다.</p>\n<ul>\n<li>초록색 메세지는 자신을 Leader로 투표해 달라는 메세지이고, 자신은 자동으로 찬성한다.</li>\n</ul>\n</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 420px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 93.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAADPUlEQVQ4y3VUS08TURTuj9OFRlm5wrhwo5tKFHHjQk0MC+MrIBqNsQGNxkejqDESQF4iKlVQUEsRebSdznRenZnOo6/p57m3w7RVuOlJ7vTMfOfxfedEsMOp1+uhsfMjtQrFMPnd9/3wnZ1OZCeg5r3xsfrtE5bH36Ds19vAWt//D7DVwe9BJkh9RfV8J6RTHUiNv274ybcbaGS3iPVqFQ5dS1PDsE/sRbnnAJLPYnBrCIP9lwQDDPvFogYvlkolaKqKvKxAzgnw3txHceQR8qKILSkHVVNRqVTCntZqfphMUDI9BJE8z4Usy01jwIYFiczSDcxtrGBgcRKa0gRt66HrOOBViJsorf+Cohc4kKoosDQdGgPNS4HlKWsZyewWFPLn6b+l5CZGxmaoKg+u6yEyPfcRwucp1HuPonT2EKz5ScgkkZwkYj77B7JtwqJnwzB4RpZpQqfsFFnCpb4hdF2M43D0Ki5f7cfy0nfqIRfaR9gn98E9tR/u2FPIpg1BzOFhKoEtx0DJdlAsFnlJDlXEeivmMug5fwvHzj5AZ9cA7t2Pt8iG9Faffg73VQyKKPC+KVQaKlXuNimrVkBJkmBZJsbGJ9F97iZ6rw/yNoUsc2bJpIIJJQDLU78c1w0BHdtuZkg+BsDKF4UMatVyg3HG8jZghaTCGq8E7KpUlud53Fe0LKhmAcuGBJuAGTmMlBxlyhKokmZD2WwDMj2p5GTsFhQN6xS56DrcV3ZcLAgbiKeXiUkXOgVLZTfRtzBBmtTaBqMpbPah7WJ0dQlfhD+IrXxCWm2Urek6N1RqMAoFCqwhXdDxNb0Gz3F2mRQGSb+57Br6R0cwPDaK4d+LiP9KwCAApj+RpJSnu5ZNY+X9OwiCuD137SUz84NNMpvYwOneF4ieuYk7b19iVc7RVCi8rwoTenodlRtnoHcfxFo81rYsWkavuef6hyZwpPs2ouce49jANcxkUlAkYp0IkLQCzJ9f4PZ0oBjdA7y+y1tV92vN0WvfgT4GHzxB5/ELuHjlHnTGYKnMZWMR0zb1i8/vzEv4j65AX0ui8s+OjDTKbWSXyWSQSMyDzbdfqwZrY+dTJsfU7IfGALQA/gV6PoaWzBYE/gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"20210630 7\"\n        title=\"20210630 7\"\n        src=\"/static/93ac93fbf9ccf8a58302d05e351df58e/d10fb/20210630-7.png\"\n        srcset=\"/static/93ac93fbf9ccf8a58302d05e351df58e/5a46d/20210630-7.png 300w,\n/static/93ac93fbf9ccf8a58302d05e351df58e/d10fb/20210630-7.png 420w\"\n        sizes=\"(max-width: 420px) 100vw, 420px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>그림 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>t</mi><mn>3</mn></msub></mrow><annotation encoding=\"application/x-tex\">t_3</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">3</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 429px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 91.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAADG0lEQVQ4y3VU+0/TUBTeH2qiv5hoUPFBJEYTfCBIVAL+oImAEoJReQgKChEY75cDJwwCMmDAnm1v261dt5bRfZ6269xDb3LT0/bc7zy+71wPKlY+n7e3a1vr+OgQx6ED2zZNs8qvdHkqwcrswqGVzQg63k8hHIkWQUuDlp7zVIK5Dmbh3bvgR+3jz7jU0I/uPm/B59+V2IDOS77KSTcMZLMapmaWUdc8iBtNwxj44oWWVul7tph9JbANaJXg9sZamqaB53lwtEUmYGHJh8mZJSTiMQiCAI7joGR1lHbQPDuzg5T1MHdKWWUIjA5ZgO5OJmWkUjLZzneBAIWAD1lZgCiJMKgSO0OrZCva9lYA/p0Ynnd58XFoAozx9mHGGGRZhkBPK4hli5IETkoiPTeM3mdPUPOgBw9beyCu+IBwDJ4MZbS4uIybTQOobR7FnaefsB/cAxNFaGq62AIllbJt43AH2a89ODjcR11jN+69mEZN4xBGu96BynBKzuVO0dY5giv3P+Bl9yji8ShEgeGYcWCGBj2TIV8HMKOkwB8d0H8O7Z39OF//BlfvvsL+yYnDskuGqipY9wcQDp9QdgxJQcTc0S6CCkOOCJCTSSfbnImkdxjqLyJpdxOzQwMIhSNODwnLU6ojTUtDYiJYgRSRyHBL1lWn8Rmyxe11mxh1dgS54EYRzKLFU6qjFGWxFznGUSIGng6kVdUBoZJ/RkPQ8yYxqiPBJPAUmLdkRCSVjmNZhqZxipn9bcyHdqClFEjEav7MRCIpYewggLSRJWGnwSUSkC22qQq1ENTF8FQqXaGmhyJhBAIBSNRLV3uKKNmtYMzZe3tBW/SmWT6yVbPMpDTau2dx4Xorvo1PQqUAMcoonIjbgPEEh94RP263DGJ8arlwWeSrAc8KfVjbiuLczde43NCH5ra3UGURE8EAxn9vkGQUfJ9eITEP4lrTCNq6xsrugeJt87fsPGUjoP5RBy7eaoVvzY9TGkdrOhiNmMV2NBojzdIAtPRhfHK+6gorI0XXDfxYXUEsFqXyePxvGXrWvih8vtWi4F2MP+efOI9DjbNWAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"20210630 8\"\n        title=\"20210630 8\"\n        src=\"/static/c6d85673ac3c692432d84537a67844f9/3d026/20210630-8.png\"\n        srcset=\"/static/c6d85673ac3c692432d84537a67844f9/5a46d/20210630-8.png 300w,\n/static/c6d85673ac3c692432d84537a67844f9/3d026/20210630-8.png 429w\"\n        sizes=\"(max-width: 429px) 100vw, 429px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>그림 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>t</mi><mn>4</mn></msub></mrow><annotation encoding=\"application/x-tex\">t_4</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">4</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></p>\n<ul>\n<li>물론 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>t</mi><mn>3</mn></msub></mrow><annotation encoding=\"application/x-tex\">t_3</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76508em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">3</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>에서 보이듯이 S2가 시작한 투표가 끝나지 않은 상황에서 다른 노드도 투표를 시작할 수 있다.</li>\n<li>\n<p>S2에 대한 투표를 다른 노드들이 찬성하고, 나중에 온 S4의 투표 메세지는 반대(<em>마이너스 표시</em>)한다.</p>\n<ul>\n<li>S2가 Leader로 선출되고 나머지 Follower들에게 주기적으로 하트비트 메세지를 보낸다.</li>\n</ul>\n</li>\n<li>이 과정이 <strong>Leader Election</strong> 과정이었고, 이후에 분산 시스템은 Leader를 통해서 데이터를 처리하게 된다.</li>\n</ul>\n<h3 id=\"22-etcd-api\" style=\"position:relative;\"><a href=\"#22-etcd-api\" aria-label=\"22 etcd api permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 etcd API</h3>\n<ul>\n<li>21년 6월 현재 기준으로 etcd API의 최신 버전은 v3.5이고, 모두 gRPC 서비스로 제공된다.</li>\n<li>각 노드에는 gRPC 서버가 있어서 클라이언트로부터 온 API 요청을 처리한다.</li>\n</ul>\n<p><strong>etcd RPC의 서비스 기능에 따른 분류</strong></p>\n<ul>\n<li><strong>KV</strong> : 키 밸류 쌍에 대한 Create, Update, Fetch, Delete 연산</li>\n<li><strong>Watch</strong> : 키 변경에 대한 모니터링</li>\n<li><strong>Lease</strong> : Primitives for consuming client keep-alive messages.</li>\n</ul>\n<p><strong>etcd 클러스터를 관리하기 위한 서비스</strong></p>\n<ul>\n<li><strong>Auth</strong> : role 기반 유저 인증</li>\n<li><strong>Cluster</strong> : Provides membership information and configuration facilities.</li>\n<li><strong>Maintenance</strong> : 리커버리를 위한 스냅샷, 저장소 조각모음, 멤버별 상태 정보 유지</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 712px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB1klEQVQ4y61T2Y7iQAzM//8TtzgFmSSbixwQINygHQkSbmpSHvWIWe3DjrSWHNux2+2u6taSyRRvhoVhECGMYjiuB9fz0evrGI0T/LLdIh7CH4YY6AZsx8ObaRVxgCCMoRum5M/nCyja+XzG8XgsNPvULMPpdMLhcECW52A+L2LaLMsln+cn/H5/l7r7/S4xrTSUL574H/J8PqGxc5IkaLfbqFQq0HUd8/kc9Xod/X5ftNFooFaroVqtotlswjCMYtrsq4lSmVA5j8cDt9sNl8tF/Ov1Ksd4VR6bedb9OZkSabjf7xFFkehisUBaTDgejxGGIdJZKj51u91is9lgNBp91XOD16Yad9vtdrBtW9T3fSn0PA+WZUk8imPEhaZpKvAQFsau6wox3xr+C9A/qRFSJpOJENJqtYQM2sFgIH6n00G320WpVBJoKDyVwpV4s6Gy2t8mYPLV/kSkIcEmVsSFlvgRR5JimqZgNZvN4DiO1JAg5ukHwVAs61ar1ScpefEiuICAs8l0OhWfC5fLpViyHwSB1JFl/luv1wIX/3EdYyFFPRsljBUUrxdY4adEMfztyLzAfBkEvlwuCxk8DonhPyqJYdzr9eTKsI4xXxCvlsKbm34AF+4c/cEvDRAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"20210630 9\"\n        title=\"20210630 9\"\n        src=\"/static/835bafe76b389c96a09e9538835f0a40/3d4b6/20210630-9.png\"\n        srcset=\"/static/835bafe76b389c96a09e9538835f0a40/5a46d/20210630-9.png 300w,\n/static/835bafe76b389c96a09e9538835f0a40/0a47e/20210630-9.png 600w,\n/static/835bafe76b389c96a09e9538835f0a40/3d4b6/20210630-9.png 712w\"\n        sizes=\"(max-width: 712px) 100vw, 712px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><a href=\"https://alibaba-cloud.medium.com/getting-started-with-kubernetes-etcd-a26cba0b4258\">https://alibaba-cloud.medium.com/getting-started-with-kubernetes-etcd-a26cba0b4258</a></p>\n<p><strong>Data Model - Logical View</strong></p>\n<ul>\n<li><em>flat binary key space</em></li>\n<li>\n<p>etcd는 데이터를 multi-version으로 저장한다.</p>\n<ul>\n<li>키의 버전은 1부터 시작하여 수정될 때마다 증가한다. 키가 삭제된 경우 버전을 0으로 재설정한다.</li>\n</ul>\n</li>\n</ul>\n<p><strong>Data Model - Physical View</strong></p>\n<ul>\n<li>\n<p>etcd는 키 밸류 쌍을 <strong><em>B+ Tree</em></strong>로 저장한다.</p>\n<ul>\n<li>B+ Tree는 키를 사전 순으로 정렬하여 저장하므로, Range Query가 매우 빠르다.</li>\n</ul>\n</li>\n<li>효율성을 위해 새로운 리비전을 모두 저장하지 않고, 이전 리비전과의 차이(delta)만 기록한다.</li>\n<li>\n<p>또한 etcd는 키에 대한 Range Query를 빠르게 하기 위해 인 메모리 B Tree를 하나 더 둔다.</p>\n<ul>\n<li>이 B Tree에 있는 키는 유저에게 노출된다.</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"3-etcd-in-kubernetes\" style=\"position:relative;\"><a href=\"#3-etcd-in-kubernetes\" aria-label=\"3 etcd in kubernetes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. etcd in Kubernetes</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAACEUlEQVQozz2SbW/SUBiG+ad+9K9oYvygP8BvmjhZpkOzwQYU2p7SUvrKOjrWrkDLiHvROTI23S4Pxdjkyjltmuvcz/OciutHNNQh/YHPwPFoiyG6GeC4HmEYEkVRiR8EBL5LWw9R5D+ea5PnBevn4f6O2fcVyfw3FUWzefE+p9b08WydNx9T3n0Z0+120DTtP6rEFArPX8U8e5mhqhppmpTCeZ5heDOCsz9UTMtG1W06qonZEwijh6I79Mw+lmXKVX7/hyXZb9t8azryECGFaSn8dXNFPyw4mkqhYTlYA1uWbGNI2duthNqhi9rtlsmEMCSiFBo9E2dg4cty1+9ZlvH0BHfLG6KzG7zkgYrVbDPc+cCg08I0dHYOhuweOCiKgud5LM5zTk/HpEnCvJgRxyfMphMm2RnT6YzHxyceVreMJrf4qRQ6hw22q4J6tY4ldKp1H03YsnSLMHCp6bIcP8Ubnpb70XFEq38uKWTvJpuhrJbEE5lyKofitJrs1kyUzw36huD11pxaK5L9NMqpfhWX2MFGuN6PRse0+3NJLhNvhPcy4cn0lqNMJtRVA0tpojbq7O0foOsGHc2iq22EVeWCnpsyCMZ8Ui45lgn3REFd5BSzrBReX10wmf+kuHykEo1inOAIL4zw/FAylHduSBBs7mCSjDmJ45JE9jKOR2VP1+tisSiFy+WSH9dXrFZ3/AUzF3FIUMRNFQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"20210630 10\"\n        title=\"20210630 10\"\n        src=\"/static/18995d04e58c023289df4de7a1d426ea/c1b63/20210630-10.png\"\n        srcset=\"/static/18995d04e58c023289df4de7a1d426ea/5a46d/20210630-10.png 300w,\n/static/18995d04e58c023289df4de7a1d426ea/0a47e/20210630-10.png 600w,\n/static/18995d04e58c023289df4de7a1d426ea/c1b63/20210630-10.png 1200w,\n/static/18995d04e58c023289df4de7a1d426ea/0d0e4/20210630-10.png 1230w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<ul>\n<li>\n<p>쿠버네티스에서는 etcd를 클러스터의 데이터(설정 데이터, 클러스터 상태, 메타데이터 등)를 관리하는 용도로 사용한다.</p>\n<ul>\n<li>etcd는 분산 환경에서 고가용성, consistency, fault-tolerance 등을 지원하므로 쿠버네티스의 백엔드로 사용하기 적합하다.</li>\n<li>etcd의 <code class=\"language-text\">Watch</code> 기능은 키의 수정에 대한 모니터링을 제공하므로, 클러스터를 <strong>선언한 상태(Desired State)</strong>로 계속해서 유지하려 하는 쿠버네티스에 적합하다.</li>\n</ul>\n</li>\n<li>쿠버네티스에서 etcd를 접근할 때는 반드시 kube-apiserver를 통해서만 접근이 가능하다.</li>\n<li>\n<p>kubectl 명령 등으로 쿠버네티스 클러스터의 데이터를 읽는 명령은 모두 etcd에 저장된 데이터를 읽어 제공된다.</p>\n<p>(예시로 kube-system 네임스페이스로 구동되고 있는 파드의 이름들을 출력해봤다.)</p>\n<ul>\n<li><strong>kubectl 사용</strong></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ kubectl get pods -n kube-system -o name\n\npod/coredns-74ff55c5b-ksmcb\npod/coredns-74ff55c5b-wjxnx\npod/dragon-tf-operator\npod/etcd-dnclab1-master\npod/kube-apiserver-dnclab1-master\npod/kube-controller-manager-dnclab1-master\npod/kube-flannel-ds-22cdr\npod/kube-flannel-ds-5lqc4\npod/kube-flannel-ds-js4jq\npod/kube-flannel-ds-ld9bs\npod/kube-proxy-9nvqm\npod/kube-proxy-ft77b\npod/kube-proxy-hxlhd\npod/kube-proxy-s6nbd\npod/kube-scheduler-dnclab1-master\npod/kube-state-metrics-5c544bc55-ffzpd\npod/metrics-server-5f8ff9b957-bpdm5\npod/nvidia-device-plugin-daemonset-1.12-9xcpn\npod/nvidia-device-plugin-daemonset-1.12-pptfm\npod/nvidia-device-plugin-daemonset-1.12-qnhxm</code></pre></div>\n<ul>\n<li><strong>etcdctl 사용</strong></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token assign-left variable\">ETCDCTL_API</span><span class=\"token operator\">=</span><span class=\"token number\">3</span> etcdctl --endpoints<span class=\"token operator\">=</span>localhost:2379 <span class=\"token punctuation\">\\</span>\n\t\t--cacert /etc/kubernetes/pki/etcd/ca.crt <span class=\"token punctuation\">\\</span>\n\t\t--cert /etc/kubernetes/pki/etcd/server.crt <span class=\"token punctuation\">\\</span>\n\t\t--key /etc/kubernetes/pki/etcd/server.key <span class=\"token punctuation\">\\</span>\n\t\tget /registry/pods/kube-system <span class=\"token punctuation\">\\</span>\n\t\t\t--prefix --keys-only\n\n/registry/pods/kube-system/coredns-74ff55c5b-ksmcb\n/registry/pods/kube-system/coredns-74ff55c5b-wjxnx\n/registry/pods/kube-system/dragon-tf-operator\n/registry/pods/kube-system/etcd-dnclab1-master\n/registry/pods/kube-system/kube-apiserver-dnclab1-master\n/registry/pods/kube-system/kube-controller-manager-dnclab1-master\n/registry/pods/kube-system/kube-flannel-ds-22cdr\n/registry/pods/kube-system/kube-flannel-ds-5lqc4\n/registry/pods/kube-system/kube-flannel-ds-js4jq\n/registry/pods/kube-system/kube-flannel-ds-ld9bs\n/registry/pods/kube-system/kube-proxy-9nvqm\n/registry/pods/kube-system/kube-proxy-ft77b\n/registry/pods/kube-system/kube-proxy-hxlhd\n/registry/pods/kube-system/kube-proxy-s6nbd\n/registry/pods/kube-system/kube-scheduler-dnclab1-master\n/registry/pods/kube-system/kube-state-metrics-5c544bc55-ffzpd\n/registry/pods/kube-system/metrics-server-5f8ff9b957-bpdm5\n/registry/pods/kube-system/nvidia-device-plugin-daemonset-1.12-9xcpn\n/registry/pods/kube-system/nvidia-device-plugin-daemonset-1.12-pptfm\n/registry/pods/kube-system/nvidia-device-plugin-daemonset-1.12-qnhxm</code></pre></div>\n<p>글 초반에 서술했듯이 키는 계층적으로 저장되고 있으며, kube-system 네임스페이스를 나타내는 키 밑에 파드들의 키 또한 생성되어 있다. 조회하고 싶은 파드에 대한 키로 조회하면 해당 파드에 대한 설정을 얻을 수 있다.  </p>\n</li>\n<li>클러스터에 존재하는 파드에 대한 상태 정보는 <code class=\"language-text\">/registry/pods/{namespace}/{pod_name}</code> 키에 존재한다.</li>\n<li>네임스페이스에 대한 정보는 <code class=\"language-text\">/registry/namespaces/{namespace}</code> 키에 존재한다.</li>\n<li>이와 같이 etcd는 쿠버네티스 클러스터를 운영함에 있어 중요한 데이터들이 관리되고 있으므로, etcd의 백업 또한 매우 중요하다. (CKA 시험에서 필수로 나온다고 들었다)</li>\n</ul>\n<h2 id=\"4-vs-other-dbs\" style=\"position:relative;\"><a href=\"#4-vs-other-dbs\" aria-label=\"4 vs other dbs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. vs other DBs</h2>\n<p>etcd는 key-value store이고 성능도 좋아보이는데, 다른 NoSQL 데이터베이스들을 아예 대체해서 사용할 수는 없을까?</p>\n<ul>\n<li>\n<p>etcd는 메인 데이터베이스로 주로 쓰이는 MongoDB 등의 DBMS와 달리, 분산 시스템의 네트워크 장애 등 상황에서 한정된 양의 데이터를 보다 더 신뢰성 있게(reliable) 관리하는 것에 중점을 두고 개발되었다.</p>\n<ul>\n<li>메타데이터와 같은 작은 키밸류 쌍을 저장하는 것으로 설계되었기 때문에 요청은 최대 1.5 MiB로 한정되어 있다.</li>\n<li>etcd 스토리지의 사이즈는 기본 2GB로 설정되어 있으며 권장되는 최대 사이즈는 8GB이다.</li>\n</ul>\n</li>\n<li>또한 안정성과 일관성을 위해 디스크에 데이터를 유지하므로, 어느정도 속도의 희생이 있다.</li>\n</ul>\n<h2 id=\"references\" style=\"position:relative;\"><a href=\"#references\" aria-label=\"references permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>References</h2>\n<p><strong>M3</strong></p>\n<ul>\n<li><a href=\"https://eng.uber.com/m3/\">https://eng.uber.com/m3/</a></li>\n<li><a href=\"https://medium.com/dataseries/uber-m3-is-an-open-source-large-scaltime-series-metrics-platform-d583aef37b07\">https://medium.com/dataseries/uber-m3-is-an-open-source-large-scaltime-series-metrics-platform-d583aef37b07</a></li>\n</ul>\n<p><strong>etcd</strong></p>\n<ul>\n<li><a href=\"https://alibaba-cloud.medium.com/getting-started-with-kubernetes-etcd-a26cba0b4258\">https://alibaba-cloud.medium.com/getting-started-with-kubernetes-etcd-a26cba0b4258</a></li>\n<li><a href=\"https://www.ibm.com/cloud/learn/etcd\">https://www.ibm.com/cloud/learn/etcd</a></li>\n<li><a href=\"https://etcd.io/docs/v3.5/learning/data_model/\">https://etcd.io/docs/v3.5/learning/data_model/</a></li>\n</ul>\n<p><strong>vs NoSQL</strong></p>\n<ul>\n<li><a href=\"https://stackoverflow.com/questions/41063238/using-etcd-as-primary-store-database\">https://stackoverflow.com/questions/41063238/using-etcd-as-primary-store-database</a></li>\n<li><a href=\"https://stackshare.io/stackups/etcd-vs-mongodb\">https://stackshare.io/stackups/etcd-vs-mongodb</a></li>\n</ul>","frontmatter":{"title":"etcd에 대해 알아보자 | 쿲벖넶팂슶 Ep.2","date":"June 30, 2021"}}},"pageContext":{"slug":"/cloud/etcd/","previous":{"fields":{"slug":"/cloud/kubernetes_1/"},"frontmatter":{"title":"쿠버네티스 | 쿲벖넶팂슶 Ep.1","category":"Cloud","draft":false}},"next":{"fields":{"slug":"/cloud/modify_nodeport_range/"},"frontmatter":{"title":"쿠버네티스 NodePort 할당 범위 변경하기","category":"Cloud","draft":false}}}},"staticQueryHashes":["3128451518","521680639"]}