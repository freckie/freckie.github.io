{"componentChunkName":"component---src-templates-blog-post-js","path":"/troubleshooting/py_shm_unlink/","result":{"data":{"site":{"siteMetadata":{"title":"킹명현 블로그","author":"Freckie","siteUrl":"https://blog.frec.kr","comment":{"disqusShortName":"","utterances":"freckie/freckie.github.io"},"sponsor":{"buyMeACoffeeId":"freckie"}}},"markdownRemark":{"id":"3fcc1271-37ee-52ad-9084-ef7ff91bab27","excerpt":"문제점 Python 3.8에서 추가된  모듈의 를 사용하는 경우, SharedMemory를 사용하던 프로세스가 종료되었을 때, 연결된 공유 메모리 블록까지 릴리즈되어 다른 프로세스에서 사용이 불가능한 문제 발생한다. SharedMemory 세그먼트를 프로세스의 종료와 관계 없이 유지하는 시나리오도 존재할 수 있지만, 파이썬에서는 memory leak로 판단하고 강제로 릴리즈함으로써 발생한다. Python 3.8 ~ 3.1…","html":"<h2 id=\"문제점\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C%EC%A0%90\" aria-label=\"문제점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제점</h2>\n<ul>\n<li>Python 3.8에서 추가된 <code class=\"language-text\">multiprocessing.shared_memory</code> 모듈의 <code class=\"language-text\">SharedMemory</code>를 사용하는 경우,</li>\n<li>\n<p>SharedMemory를 사용하던 프로세스가 종료되었을 때, 연결된 공유 메모리 블록까지 릴리즈되어 다른 프로세스에서 사용이 불가능한 문제 발생한다.</p>\n<ul>\n<li>SharedMemory 세그먼트를 프로세스의 종료와 관계 없이 유지하는 시나리오도 존재할 수 있지만, 파이썬에서는 <strong>memory leak로 판단하고 강제로 릴리즈함</strong>으로써 발생한다.</li>\n</ul>\n</li>\n<li>Python 3.8 ~ 3.11에서 발생한다.</li>\n</ul>\n<h3 id=\"문제-재현-시나리오\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C-%EC%9E%AC%ED%98%84-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4\" aria-label=\"문제 재현 시나리오 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제 재현 시나리오</h3>\n<p>(파이썬 프로세스 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mn>1</mn></msub></mrow><annotation encoding=\"application/x-tex\">P_1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>, <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mn>2</mn></msub></mrow><annotation encoding=\"application/x-tex\">P_2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>, <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mn>3</mn></msub></mrow><annotation encoding=\"application/x-tex\">P_3</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">3</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>가 같은 공유 메모리 블록에 접근하려는 상황)</p>\n<ol>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mn>1</mn></msub></mrow><annotation encoding=\"application/x-tex\">P_1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>이 SharedMemory를 생성</li>\n<li>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mn>2</mn></msub></mrow><annotation encoding=\"application/x-tex\">P_2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>가 해당 공유 메모리 블록에 접근하고, 작업을 처리한 후 프로세스 종료</p>\n<ul>\n<li>\n<p>Warning 발생</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">UserWarning<span class=\"token punctuation\">:</span> resource_tracker<span class=\"token punctuation\">:</span> There appear to be <span class=\"token number\">1</span> leaked shared_memory objects to clean up at shutdown\n  warnings<span class=\"token punctuation\">.</span>warn<span class=\"token punctuation\">(</span><span class=\"token string\">'resource_tracker: There appear to be %d '</span></code></pre></div>\n</li>\n</ul>\n</li>\n<li>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>P</mi><mn>3</mn></msub></mrow><annotation encoding=\"application/x-tex\">P_3</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">3</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>가 해당 공유 메모리 블록에 접근 시도</p>\n<ul>\n<li>\n<p>에러 발생</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">FileNotFoundError<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>Errno <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> No such <span class=\"token builtin\">file</span> <span class=\"token keyword\">or</span> directory<span class=\"token punctuation\">:</span> <span class=\"token string\">'/test'</span></code></pre></div>\n</li>\n</ul>\n</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> multiprocessing<span class=\"token punctuation\">.</span>shared_memory <span class=\"token keyword\">import</span> SharedMemory\n\n<span class=\"token comment\">### Process 1</span>\nshm <span class=\"token operator\">=</span> SharedMemory<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">'test'</span><span class=\"token punctuation\">,</span> create<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> size<span class=\"token operator\">=</span><span class=\"token number\">4096</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># 대기</span>\n\n<span class=\"token comment\">### Process 2</span>\nshm <span class=\"token operator\">=</span> SharedMemory<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">'test'</span><span class=\"token punctuation\">,</span> create<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># ...</span>\nexit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># Warning 발생</span>\n\n<span class=\"token comment\">### Process 3</span>\nshm <span class=\"token operator\">=</span> SharedMemory<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">'test'</span><span class=\"token punctuation\">,</span> create<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># 에러 발생</span></code></pre></div>\n<h3 id=\"문제-원인\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C-%EC%9B%90%EC%9D%B8\" aria-label=\"문제 원인 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제 원인</h3>\n<ul>\n<li>\n<p><code class=\"language-text\">multiprocessing</code> 라이브러리에는 <code class=\"language-text\">ResourceTracker</code>가 존재하며, SharedMemory 오브젝트 생성 시 해당 오브젝트는 <strong>ResourceTracker의 감시 대상에 등록</strong>된다. (create=True인 경우나 False인 경우 모두 포함) [1]</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\">### Lib/multiprocessing/shared_memory.py</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">SharedMemory</span><span class=\"token punctuation\">:</span>\n\t<span class=\"token comment\"># ...</span>\n\n\t<span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> name<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> create<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> size<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\t\t  <span class=\"token comment\"># ...</span>\n\t\t\n\t\t  <span class=\"token keyword\">if</span> _USE_POSIX<span class=\"token punctuation\">:</span>\n\t\t\n\t\t      <span class=\"token comment\"># POSIX Shared Memory</span>\n\t\t\n\t\t      <span class=\"token keyword\">if</span> name <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n\t\t          <span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n\t\t              name <span class=\"token operator\">=</span> _make_filename<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t              <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n\t\t                  self<span class=\"token punctuation\">.</span>_fd <span class=\"token operator\">=</span> _posixshmem<span class=\"token punctuation\">.</span>shm_open<span class=\"token punctuation\">(</span>\n\t\t                      name<span class=\"token punctuation\">,</span>\n\t\t                      self<span class=\"token punctuation\">.</span>_flags<span class=\"token punctuation\">,</span>\n\t\t                      mode<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>_mode\n\t\t                  <span class=\"token punctuation\">)</span>\n\t\t              <span class=\"token keyword\">except</span> FileExistsError<span class=\"token punctuation\">:</span>\n\t\t                  <span class=\"token keyword\">continue</span>\n\t\t              self<span class=\"token punctuation\">.</span>_name <span class=\"token operator\">=</span> name\n\t\t              <span class=\"token keyword\">break</span>\n\t\t      <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n\t\t          name <span class=\"token operator\">=</span> <span class=\"token string\">\"/\"</span> <span class=\"token operator\">+</span> name <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>_prepend_leading_slash <span class=\"token keyword\">else</span> name\n\t\t          self<span class=\"token punctuation\">.</span>_fd <span class=\"token operator\">=</span> _posixshmem<span class=\"token punctuation\">.</span>shm_open<span class=\"token punctuation\">(</span>\n\t\t              name<span class=\"token punctuation\">,</span>\n\t\t              self<span class=\"token punctuation\">.</span>_flags<span class=\"token punctuation\">,</span>\n\t\t              mode<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>_mode\n\t\t          <span class=\"token punctuation\">)</span>\n\t\t          self<span class=\"token punctuation\">.</span>_name <span class=\"token operator\">=</span> name\n\t\t      <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n\t\t          <span class=\"token keyword\">if</span> create <span class=\"token keyword\">and</span> size<span class=\"token punctuation\">:</span>\n\t\t              os<span class=\"token punctuation\">.</span>ftruncate<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>_fd<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span>\n\t\t          stats <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>fstat<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>_fd<span class=\"token punctuation\">)</span>\n\t\t          size <span class=\"token operator\">=</span> stats<span class=\"token punctuation\">.</span>st_size\n\t\t          self<span class=\"token punctuation\">.</span>_mmap <span class=\"token operator\">=</span> mmap<span class=\"token punctuation\">.</span>mmap<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>_fd<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span>\n\t\t      <span class=\"token keyword\">except</span> OSError<span class=\"token punctuation\">:</span>\n\t\t          self<span class=\"token punctuation\">.</span>unlink<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t          <span class=\"token keyword\">raise</span>\n\t\t\n\t\t      resource_tracker<span class=\"token punctuation\">.</span>register<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>_name<span class=\"token punctuation\">,</span> <span class=\"token string\">\"shared_memory\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n<li>\n<p>ResourceTracker는 파이썬 프로세스 종료 시 unlink 되지 않은 SharedMemory 오브젝트가 있다면 <strong>경고를 날리며 unlink를 호출</strong>한다. [2] (leak으로 간주)</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\">### Lib/multiprocessing/resource_tracker.py</span>\n\n<span class=\"token comment\"># Line 49-51</span>\n_CLEANUP_FUNCS<span class=\"token punctuation\">.</span>update<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'shared_memory'</span><span class=\"token punctuation\">:</span> _posixshmem<span class=\"token punctuation\">.</span>shm_unlink<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Line 229-239</span>\n<span class=\"token keyword\">for</span> name <span class=\"token keyword\">in</span> rtype_cache<span class=\"token punctuation\">:</span>\n\t  <span class=\"token comment\"># For some reason the process which created and registered this</span>\n\t  <span class=\"token comment\"># resource has failed to unregister it. Presumably it has</span>\n\t  <span class=\"token comment\"># died.  We therefore unlink it.</span>\n\t  <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n\t      <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n\t          _CLEANUP_FUNCS<span class=\"token punctuation\">[</span>rtype<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span>\n\t\t      <span class=\"token keyword\">except</span> Exception <span class=\"token keyword\">as</span> e<span class=\"token punctuation\">:</span>\n\t          warnings<span class=\"token punctuation\">.</span>warn<span class=\"token punctuation\">(</span><span class=\"token string\">'resource_tracker: %r: %s'</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t  <span class=\"token keyword\">finally</span><span class=\"token punctuation\">:</span>\n\t      <span class=\"token keyword\">pass</span></code></pre></div>\n</li>\n</ul>\n<h2 id=\"해결-방법\" style=\"position:relative;\"><a href=\"#%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95\" aria-label=\"해결 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>해결 방법</h2>\n<ul>\n<li>ResourceTracker는 세마포어가 프로세스 종료에도 남아있는 상황을 피하기 위해 구현되었으나, SharedMemory에도 적용되어 잘못된 결과를 가져오는 버그가 되었다.</li>\n<li>\n<p>파이썬 이슈트래커에 이번 버그에 대해 논의가 있었고 솔루션도 제시되어 PR이 있지만, 2022.10.28기준 3.11 버전에서도 아직 머지되지 않았으며 방치된 상태이다.</p>\n<ul>\n<li><a href=\"https://github.com/python/cpython/issues/82300\">Issue #82300(bpo-38119)</a>, <a href=\"https://github.com/python/cpython/issues/84140\">Issue #84180(bpo-39959)</a>, <a href=\"https://github.com/python/cpython/pull/15989/files\">PR #15989(bpo-38119)</a></li>\n</ul>\n</li>\n<li>이슈 #84180에서 shared_memory.py 파일을 수정에 로컬로 사용하는 임시 솔루션을 제시한다. (<a href=\"https://github.com/python/cpython/issues/84140#issuecomment-1093865808\">해당 코멘트</a>)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># Lib/multiprocessing/shared_memory.py</span>\n\n<span class=\"token comment\"># Line 120</span>\nresource_tracker<span class=\"token punctuation\">.</span>register<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>_name<span class=\"token punctuation\">,</span> <span class=\"token string\">\"shared_memory\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># Lib/multiprocessing/shared_memory.py</span>\n\n<span class=\"token comment\"># Line 120</span>\n<span class=\"token keyword\">if</span> create<span class=\"token punctuation\">:</span>\n\t\tresource_tracker<span class=\"token punctuation\">.</span>register<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>_name<span class=\"token punctuation\">,</span> <span class=\"token string\">\"shared_memory\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>혹은 라인 120을 아예 주석처리해서 ResourceTracker가 관여하지 못하게 할 수도 있다.</li>\n</ul>\n<h2 id=\"참고\" style=\"position:relative;\"><a href=\"#%EC%B0%B8%EA%B3%A0\" aria-label=\"참고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>참고</h2>\n<p>[1] <a href=\"https://github.com/python/cpython/blob/3.10/Lib/multiprocessing/shared_memory.py#L120\">Lib/multiprocessing/shared_memory.py - Line 120</a>\n[2] <a href=\"https://github.com/python/cpython/blob/3.10/Lib/multiprocessing/resource_tracker.py\">Lib/multiprocessing/resource_tracker.py</a></p>\n<ul>\n<li><a href=\"https://stackoverflow.com/questions/62748654/python-3-8-shared-memory-resource-tracker-producing-unexpected-warnings-at-appli\">https://stackoverflow.com/questions/62748654/python-3-8-shared-memory-resource-tracker-producing-unexpected-warnings-at-appli</a></li>\n<li><a href=\"https://bugs.python.org/issue39959\">https://bugs.python.org/issue39959</a></li>\n<li><a href=\"https://bugs.python.org/issue38119\">https://bugs.python.org/issue38119</a></li>\n<li><a href=\"https://github.com/python/cpython/pull/15989/files\">https://github.com/python/cpython/pull/15989/files</a></li>\n</ul>","frontmatter":{"title":"파이썬 SharedMemory 사용 시 자동으로 unlink가 호출되는 문제","date":"2022년 10월 28일 작성","series":null}}},"pageContext":{"slug":"/troubleshooting/py_shm_unlink/","previous":{"fields":{"slug":"/golang/go-hashtable-0/"},"frontmatter":{"title":"Go에서 해시 테이블(Map)은 어떻게 구현되어 있을까?","category":"GoLang","draft":false}},"next":{"fields":{"slug":"/spring/spring-batch-5-metadata-db/"},"frontmatter":{"title":"Spring Batch 5.0에서 배치용 메타데이터 DB와 서비스 DB 분리하기","category":"Spring","draft":false}}}},"staticQueryHashes":["3128451518","521680639"]}